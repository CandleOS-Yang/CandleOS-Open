物理存储层
├── 磁盘（物理硬盘或虚拟磁盘）
│   └── 分区（Partition，如 C: 盘）
│       └── 文件系统（如 NTFS、FAT32）
│           ├── **元数据区**
│           │   ├── 引导扇区（Boot Sector）
│           │   ├── 文件分配表（FAT）或主文件表（MFT）
│           │   └── 根目录区（Root Directory）
│           └── **数据区**
│               ├── 根目录（逻辑起点，路径为 `C:\`）
│               │   ├── 文件（如 `file1.txt`）
│               │   └── 子目录（如 `Folder1`）
│               │       ├── 文件（如 `subfile.txt`）
│               │       └── 子目录（如 `Subfolder`）
│               └── ...（其他数据块）
└── ...（其他分区，如 D: 盘）


/* 功能2 写入文件到FAT16文件系统 */
void write_file_to_fat16(FILE *infile, FILE *outfile,u32 partition_num, char *input_file_name) {
    printf("[ INFO ] Writing file to FAT16 file system...\n");
    
    get_partition_info(outfile, partition_num, &partition_info, &mbr_bios_block);

    dbr_block_t *dbr = (dbr_block_t *)malloc(SECTOR_SIZE);
    if (dbr == NULL) {
        printf("[ ERROR ] Failed to allocate memory for dbr\n");
        return;
    }
    memset(dbr, 0, SECTOR_SIZE);
    read_dbr(infile, (void *)dbr);

    char file_fat_name[12];
    char file_name[12];
    u16 *fat_buffer = (u16 *)malloc(partition_info.fat_sectors * SECTOR_SIZE);
    u8 *rootdir_buffer = (u8 *)malloc(partition_info.rootdir_sectors * SECTOR_SIZE);
    if (fat_buffer == NULL || rootdir_buffer == NULL) {
        printf("[ ERROR ] Failed to allocate memory for fat_buffer or rootdir_buffer\n");
        return;
    }
    memset(fat_buffer, 0, partition_info.fat_sectors * SECTOR_SIZE);
    memset(rootdir_buffer, 0, partition_info.rootdir_sectors * SECTOR_SIZE);
    read_fat(outfile, 0, (void *)fat_buffer);
    read_rootdir(outfile, (void *)rootdir_buffer);

    u32 size = get_file_size(infile);
    u32 data_sector_count = ceil(size, SECTOR_SIZE); 
    u8 *data_buffer = (u8 *)malloc(data_sector_count * SECTOR_SIZE);
    if (data_buffer == NULL) {
        printf("[ ERROR ] Failed to allocate memory for data_buffer\n");
        return;
    }
    memset(data_buffer, 0, data_sector_count * SECTOR_SIZE);

    get_file_name(file_name, input_file_name);
    convert_file_name(file_fat_name, file_name);

    fat_buffer[0] = 0xfff8;
    fat_buffer[1] = 0xffff;

    u16 file_start_cluster = get_cluster(fat_buffer);
    if (file_start_cluster == 0) {
        printf("[ ERROR ] Failed to get cluster\n");
        return;
    }
    u32 data_start_sector = partition_info.data_balance + file_start_cluster;

    dir_t *dir_entry = get_dir_entry(rootdir_buffer);
    if (dir_entry == NULL) {
        printf("[ ERROR ] Failed to get dir_entry\n");
        return;
    }
    strncpy((char *)dir_entry->DIR_Name, file_fat_name, 8);
    strncpy((char *)dir_entry->DIR_Ext, file_fat_name + 8, 3);

    dir_entry->DIR_FstClus = file_start_cluster;
    dir_entry->DIR_FileSize = size;
    
    if (strcmp(file_fat_name + 8, "   ")) {     // 没有扩展名，文件
        dir_entry->DIR_Attr = 0x20;
    } else {                                    // 有扩展名，目录
        dir_entry->DIR_Attr = 0x10;
    } // 其他判断

    u16 cluster = file_start_cluster;
    u8 *data_buffer_ptr = data_buffer;
    for (u32 i = 0; i < data_sector_count; i++) {
        disk_read(infile, data_buffer_ptr, i, size);
        disk_write(outfile, data_buffer_ptr, data_start_sector, SECTOR_SIZE);

        cluster = link_cluster(fat_buffer, cluster);
        if (cluster == 0) {
            printf("[ ERROR ] Failed to link cluster\n");
            return;
        }

        data_start_sector = partition_info.data_balance + cluster;
        data_buffer_ptr += SECTOR_SIZE;
    }
    fat_buffer[cluster] = 0xffff;

    write_fat(outfile, 0, (void *)fat_buffer);
    write_rootdir(outfile, (void *)rootdir_buffer);

    printf("[ INFO ] File size: %d\n", size);
    printf("[ INFO ] FAT16 file name: %s\n", file_fat_name);
    printf("[ INFO ] File start cluster: %d\n", file_start_cluster);
    printf("[ INFO ] Data base: %p\n", (data_start_sector - data_sector_count) * SECTOR_SIZE);

    free(dbr);
    free(data_buffer);
    free(fat_buffer);
    free(rootdir_buffer);
    
    printf("[ INFO ] Writed file to FAT16 file system successfully!\n");
}